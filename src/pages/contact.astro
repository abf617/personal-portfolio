---
import Layout from "../layouts/Layout.astro";
import TopNav from "../components/TopNav.astro";
import Footer from "../components/Footer.astro";
import GlitchTransition from "../components/GlitchTransition.jsx";
import TypedHeading from "../components/TypedHeading.jsx";
import { getRequiredEntry } from "../utils/contentUtils";

const formsUI = await getRequiredEntry("ui", "forms");
const contactForm = formsUI.data.strings.contact;
---

<Layout title="Contact" description="Get in touch with me">
  <TopNav />

  <main class="container mx-auto px-6 py-12">
    <div class="max-w-3xl mx-auto">
      <GlitchTransition client:only="react" trigger={true}>
        <!-- Page Header -->
        <div class="terminal-window mb-12">
          <TypedHeading
            client:visible
            strings={[contactForm.title]}
            typeSpeed={50}
            showCursor={false}
            loop={false}
            onComplete={() => {}}
            className="font-display text-3xl md:text-4xl font-bold text-neon-cyan phosphor-glow mb-4"
          />
          <div class="font-mono text-sm text-neon-magenta pt-6">
            <span class="text-neon-green">$</span>
            {contactForm.status}
          </div>
        </div>

        <!-- Contact Form -->
        <div class="terminal-window mb-12">
          <form
            class="space-y-6"
            id="contact-form"
            action="https://formspree.io/f/xvzboyek"
            method="POST"
          >
            <!-- Name Field -->
            <div>
              <label for="name" class="font-mono text-neon-green block mb-2">
                <span class="text-neon-cyan">&gt;</span>
                {contactForm.nameLabel}
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                maxlength="100"
                class="w-full bg-terminal-black border border-neon-cyan/50 text-neon-cyan font-mono px-4 py-2 focus:outline-none focus:border-neon-cyan focus:shadow-neon-cyan rounded"
                placeholder={contactForm.namePlaceholder}
              />
            </div>

            <!-- Email Field -->
            <div>
              <label for="email" class="font-mono text-neon-green block mb-2">
                <span class="text-neon-cyan">&gt;</span>
                {contactForm.emailLabel}
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                maxlength="254"
                class="w-full bg-terminal-black border border-neon-cyan/50 text-neon-cyan font-mono px-4 py-2 focus:outline-none focus:border-neon-cyan focus:shadow-neon-cyan rounded"
                placeholder={contactForm.emailPlaceholder}
              />
            </div>

            <!-- Message Field -->
            <div>
              <label for="message" class="font-mono text-neon-green block mb-2">
                <span class="text-neon-cyan">&gt;</span>
                {contactForm.messageLabel}
              </label>
              <textarea
                id="message"
                name="message"
                required
                rows="6"
                maxlength="5000"
                class="w-full bg-terminal-black border border-neon-cyan/50 text-neon-cyan font-mono px-4 py-2 focus:outline-none focus:border-neon-cyan focus:shadow-neon-cyan rounded resize-none"
                placeholder={contactForm.messagePlaceholder}></textarea>
            </div>

            <!-- Honeypot field - hidden from humans, catches bots -->
            <input
              type="text"
              name="_gotcha"
              style="display:none"
              tabindex="-1"
              autocomplete="off"
              aria-hidden="true"
            />

            <!-- Submit Button -->
            <button
              type="submit"
              id="submit-button"
              class="terminal-window px-6 py-3 font-mono text-neon-cyan hover:text-neon-magenta transition-colors duration-300 chromatic-aberration w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:text-neon-cyan"
            >
              <span class="text-neon-green">{contactForm.submitButtonKey}</span>
              {contactForm.submitButtonText}
            </button>

            <!-- Status Message -->
            <div
              id="form-status"
              class="hidden font-mono text-sm mt-4"
              role="status"
              aria-live="polite"
              aria-atomic="true"
            ></div>
          </form>
        </div>

        <!-- Social Links -->
        <div class="terminal-window">
          <h2 class="font-mono text-neon-magenta text-xl mb-4">
            <span class="text-neon-green">&gt;</span> Other connection methods:
          </h2>
          <div class="space-y-3 font-mono">
            <a
              href="https://github.com/abf617"
              target="_blank"
              rel="noopener noreferrer"
              class="block text-neon-cyan hover:text-neon-magenta transition-colors chromatic-aberration"
            >
              <span class="text-neon-green">$</span> open github.com/abf617
            </a>
            <a
              href="https://www.linkedin.com/in/allen-aronis-45111261/"
              target="_blank"
              rel="noopener noreferrer"
              class="block text-neon-cyan hover:text-neon-magenta transition-colors chromatic-aberration"
            >
              <span class="text-neon-green">$</span> connect linkedin.com/in/allen-aronis
            </a>
          </div>
        </div>
      </GlitchTransition>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  // Handle form submission - wait for React component to render

  // Function to initialize form handling
  function initializeForm() {
    const form = document.getElementById(
      "contact-form",
    ) as HTMLFormElement | null;
    const status = document.getElementById("form-status");
    const submitButton = document.getElementById(
      "submit-button",
    ) as HTMLButtonElement | null;

    if (form && status && submitButton) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Get form data FIRST (before disabling inputs)
        const formData = new FormData(form);

        // Get all form inputs
        const inputs = form.querySelectorAll(
          "input:not([name='_gotcha']), textarea, button",
        ) as NodeListOf<HTMLInputElement | HTMLTextAreaElement | HTMLButtonElement>;

        // Disable all inputs during submission
        inputs.forEach((input) => (input.disabled = true));

        // Show loading message (and clear any previous error)
        status.classList.remove("hidden");
        status.className = "font-mono text-sm mt-4 text-neon-cyan";
        status.textContent = "> Sending message... [████░░░░░░] 40%";

        try {

          // Submit to Formspree
          const response = await fetch(form.action, {
            method: "POST",
            body: formData,
            headers: {
              Accept: "application/json",
            },
          });

          if (response.ok) {
            status.className = "font-mono text-sm mt-4 text-neon-green";
            status.textContent =
              "✓ Message sent successfully! [██████████] 100%\n> Timestamp: " +
              new Date().toLocaleTimeString();

            // Reset form
            form.reset();

            // Keep all inputs disabled and success message visible permanently
          } else {
            // Parse Formspree error response for better error messages
            const data = await response.json();
            const errorMessage =
              data.error ||
              data.errors?.[0]?.message ||
              "Form submission failed";
            throw new Error(errorMessage);
          }
        } catch (error) {
          status.className = "font-mono text-sm mt-4 text-neon-magenta";
          status.textContent =
            "✗ Error sending message. Please try again.\n> ERROR: " +
            (error instanceof Error ? error.message : String(error));

          // Re-enable all inputs on error so user can try again
          inputs.forEach((input) => (input.disabled = false));

          // Error message stays visible until next submission attempt
        }
      });

      return true;
    }

    return false;
  }

  // Try to initialize immediately
  if (!initializeForm()) {
    // If not found, wait for elements to appear (React hydration)
    const observer = new MutationObserver(() => {
      if (initializeForm()) {
        observer.disconnect();
      }
    });

    // Watch for changes in the body
    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });

    // Fallback: stop observing after 5 seconds
    setTimeout(() => {
      observer.disconnect();
    }, 5000);
  }
</script>
